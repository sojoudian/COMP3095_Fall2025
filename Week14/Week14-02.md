# Week 14 - Supplemental Guide

## Important Prerequisites & Corrections

This guide supplements **Week14.md** with additional steps required by the lab instructions (week9.2.pdf and week10.1.pdf) that were not included in the main guide.

---

## Step A: Remove Spring Boot DevTools from order-service

**Required by:** week10.1.pdf (explicit requirement)

Before implementing Kafka and Schema Registry, you must remove the Spring Boot DevTools dependency from `order-service`.

### A.1 Update order-service/build.gradle.kts

Open `order-service/build.gradle.kts` and **remove or comment out** the devtools dependency:

```kotlin
// ❌ REMOVE THIS LINE (or comment it out):
// developmentOnly("org.springframework.boot:spring-boot-devtools")
```

**Why?** The PDF states: *"Remove Devtools: In both order-service and notification-service > build.gradle.kts remove, (or comment out) the devtools dependency"*

---

## Step B: Fix notification-service build.gradle.kts

**Issue:** The main guide (Week14.md Step 3) uses Spring Boot 4.0.0 which does not exist, and includes invalid test dependencies.

### B.1 Correct the Spring Boot Version

Change the Spring Boot version from `4.0.0` to a valid version:

```kotlin
plugins {
    java
    // ❌ WRONG: id("org.springframework.boot") version "4.0.0"
    // ✅ CORRECT:
    id("org.springframework.boot") version "3.4.4"
    id("io.spring.dependency-management") version "1.1.7"
}
```

### B.2 Fix the Test Dependencies

Replace the invalid test dependencies in `notification-service/build.gradle.kts`:

```kotlin
// ❌ REMOVE THESE INVALID DEPENDENCIES:
// testImplementation("org.springframework.boot:spring-boot-starter-actuator-test")
// testImplementation("org.springframework.boot:spring-boot-starter-kafka-test")
// testImplementation("org.springframework.boot:spring-boot-starter-mail-test")

// ✅ ADD THESE CORRECT DEPENDENCIES:
testImplementation("org.springframework.boot:spring-boot-starter-test")
testImplementation("org.springframework.boot:spring-boot-testcontainers")
testImplementation("org.springframework.kafka:spring-kafka-test")
testImplementation("org.testcontainers:junit-jupiter")
testImplementation("org.testcontainers:kafka")
testRuntimeOnly("org.junit.platform:junit-platform-launcher")
```

### B.3 Complete Correct notification-service/build.gradle.kts

Here is the complete corrected file:

```kotlin
plugins {
    java
    id("org.springframework.boot") version "3.4.4"
    id("io.spring.dependency-management") version "1.1.7"
}

group = "ca.gbc"
version = "0.0.1-SNAPSHOT"

java {
    toolchain {
        languageVersion = JavaLanguageVersion.of(21)
    }
}

configurations {
    compileOnly {
        extendsFrom(configurations.annotationProcessor.get())
    }
}

repositories {
    mavenCentral()
    maven {
        url = uri("https://packages.confluent.io/maven/")
    }
}

dependencies {
    implementation("org.springframework.boot:spring-boot-starter-actuator")
    implementation("org.springframework.boot:spring-boot-starter-mail")
    implementation("org.springframework.boot:spring-boot-starter-web")
    implementation("org.springframework.kafka:spring-kafka")
    compileOnly("org.projectlombok:lombok")

    // Week 14 - Avro & Schema Registry
    implementation("org.apache.avro:avro:1.12.0")
    implementation("io.confluent:kafka-schema-registry-client:8.0.0")
    implementation("io.confluent:kafka-avro-serializer:8.0.0")

    // Week 14 - Shared Schema Project
    implementation(project(":shared-schema"))

    // DevTools REMOVED for Week 14
    // developmentOnly("org.springframework.boot:spring-boot-devtools")

    annotationProcessor("org.projectlombok:lombok")
    testImplementation("org.springframework.boot:spring-boot-starter-test")
    testImplementation("org.springframework.boot:spring-boot-testcontainers")
    testImplementation("org.springframework.kafka:spring-kafka-test")
    testImplementation("org.testcontainers:junit-jupiter")
    testImplementation("org.testcontainers:kafka")
    testRuntimeOnly("org.junit.platform:junit-platform-launcher")
}

tasks.withType<Test> {
    useJUnitPlatform()
}
```

---

## Step C: Update Docker Properties for Avro & Schema Registry

**Issue:** The main guide (Week14.md) only updates the local `application.properties` files for Avro serialization. The `application-docker.properties` files still use JSON serializers, which will cause issues when running in Docker.

### C.1 Update order-service/src/main/resources/application-docker.properties

Add/update the Kafka producer properties to use Avro serialization:

```properties
# Week 14 - Kafka Producer Properties (Docker)
spring.kafka.bootstrap-servers=broker:29092
spring.kafka.template.default-topic=order-placed
spring.kafka.producer.key-serializer=org.apache.kafka.common.serialization.StringSerializer

# Week 14 - Avro Serializer with Schema Registry (Docker)
spring.kafka.producer.value-serializer=io.confluent.kafka.serializers.KafkaAvroSerializer
spring.kafka.producer.properties.schema.registry.url=http://schema-registry:8087
```

**Note:** In Docker, the Schema Registry URL uses the container name `schema-registry` instead of `localhost` or `127.0.0.1`.

### C.2 Update notification-service/src/main/resources/application-docker.properties

Add/update the Kafka consumer properties to use Avro deserialization:

```properties
spring.application.name=notification-service

# Week 14
server.port=8085

# Week 14 - Kafka Consumer Properties (Docker)
spring.kafka.bootstrap-servers=broker:29092
spring.kafka.consumer.group-id=notificationService
spring.kafka.consumer.key-deserializer=org.apache.kafka.common.serialization.StringDeserializer
spring.kafka.consumer.auto-offset-reset=earliest

# Week 14 - Avro Deserializer with Error Handling (Docker)
spring.kafka.consumer.value-deserializer=org.springframework.kafka.support.serializer.ErrorHandlingDeserializer
spring.kafka.consumer.properties.spring.deserializer.key.delegate.class=org.apache.kafka.common.serialization.StringDeserializer
spring.kafka.consumer.properties.spring.deserializer.value.delegate.class=io.confluent.kafka.serializers.KafkaAvroDeserializer
spring.kafka.consumer.properties.schema.registry.url=http://schema-registry:8087
spring.kafka.consumer.properties.specific.avro.reader=true

# Week 14 - Actuator & Logging
management.endpoints.web.exposure.include=*
management.endpoint.health.show-details=always
logging.level.org.springframework.kafka=DEBUG
logging.level.ca.gbc.comp3095.notificationservice=DEBUG

# Week 14 - MailTrap Configuration
spring.mail.host=sandbox.smtp.mailtrap.io
spring.mail.port=2525
spring.mail.username=YOUR_MAILTRAP_USERNAME
spring.mail.password=YOUR_MAILTRAP_PASSWORD
spring.mail.from=noreply@comp3095.ca
spring.mail.properties.mail.smtp.auth=true
spring.mail.properties.mail.smtp.starttls.enable=true
```

**Important:** Replace `YOUR_MAILTRAP_USERNAME` and `YOUR_MAILTRAP_PASSWORD` with your actual MailTrap credentials.

---

## Step D: Verify shared-schema Module Configuration

### D.1 Verify settings.gradle.kts includes shared-schema

Ensure your `microservices-parent/settings.gradle.kts` includes the shared-schema module:

```kotlin
rootProject.name = "microservices-parent"

include("product-service", "order-service", "inventory-service", "api-gateway", "notification-service")
include("shared-schema")
```

### D.2 Build the shared-schema Module

**CRITICAL:** You must build the shared-schema module to generate the Avro Java classes before the project will compile.

**Using Terminal:**
```bash
cd microservices-parent
./gradlew :shared-schema:build
```

**Using IntelliJ Gradle Panel:**
1. Open the **Gradle** panel (right sidebar, elephant icon)
2. Navigate to: `microservices-parent` → `shared-schema` → `Tasks` → `build` → `build`
3. **Double-click** `build`

After building, verify the generated class exists at:
```
shared-schema/build/generated-main-avro-java/ca/gbc/comp3095/orderservice/event/OrderPlacedEvent.java
```

---

## Summary of Changes Not in Week14.md

| Issue | Location | Fix |
|-------|----------|-----|
| DevTools not removed | order-service/build.gradle.kts | Remove/comment `developmentOnly("spring-boot-devtools")` |
| Invalid Spring Boot version | notification-service/build.gradle.kts | Change 4.0.0 → 3.4.4 |
| Invalid test dependencies | notification-service/build.gradle.kts | Use spring-kafka-test, testcontainers |
| Docker uses JSON not Avro | order-service/application-docker.properties | Use KafkaAvroSerializer + schema.registry.url |
| Docker uses JSON not Avro | notification-service/application-docker.properties | Use KafkaAvroDeserializer + schema.registry.url |

---

## Troubleshooting

### Error: "Cannot resolve symbol 'event'" or "OrderPlacedEvent"
**Solution:** Build the shared-schema module first (Step D.2)

### Error: "No beans of 'JavaMailSender' type found"
**Solution:** This is an IDE warning. Run `./gradlew build` or sync Gradle in IntelliJ.

### Error: "Connection refused" to Schema Registry in Docker
**Solution:** Ensure `application-docker.properties` uses `http://schema-registry:8087` (not localhost)

### Error: Serialization/Deserialization failure in Docker
**Solution:** Ensure both order-service and notification-service docker properties use Avro serializers (Step C)
