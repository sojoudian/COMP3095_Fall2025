
## Step C: Update Docker Properties for Avro & Schema Registry

**Issue:** The main guide (Week14.md) only updates the local `application.properties` files for Avro serialization. The `application-docker.properties` files still use JSON serializers, which will cause issues when running in Docker.

### C.1 Update order-service/src/main/resources/application-docker.properties

Replace the entire file with the following complete configuration:

```properties
# ============================================
# Order Service - Docker Configuration
# Activated when SPRING_PROFILES_ACTIVE=docker
# ============================================

# Application Configuration
spring.application.name=order-service

# Server Configuration
server.port=8082

# PostgreSQL Configuration for DOCKER environment
# IMPORTANT: Use service name "postgres" instead of "localhost"
spring.datasource.url=jdbc:postgresql://postgres-order:5432/order_service

spring.datasource.username=admin
spring.datasource.password=password
spring.datasource.driver-class-name=org.postgresql.Driver

# JPA/Hibernate Configuration
spring.jpa.hibernate.ddl-auto=none
spring.jpa.show-sql=true
spring.jpa.properties.hibernate.dialect=org.hibernate.dialect.PostgreSQLDialect
spring.jpa.properties.hibernate.format_sql=true

# Logging Configuration
logging.level.ca.gbc.comp3095=INFO
logging.level.org.hibernate.SQL=DEBUG
logging.level.org.hibernate.type.descriptor.sql.BasicBinder=TRACE

# Actuator Configuration
management.endpoints.web.exposure.include=*
management.endpoint.health.show-details=always

inventory.service.url=http://inventory-service:8083

# Week 12 - API version for documentation
order-service.version=v1.0

# Week 12 - Swagger Documentation
springdoc.swagger-ui.path=/swagger-ui
springdoc.api-docs.path=/api-docs

# Week 13
spring.flyway.baseline-on-migrate=true
spring.flyway.locations=classpath:db/migration
spring.flyway.enabled=true

# Week 9 - Day 1 - Circuit Breaker Configuration
management.health.circuitbreakers.enabled=true

# Week 9 - Day 1 - Resilience4j Circuit Breaker Configuration
resilience4j.circuitbreaker.instances.inventory.registerHealthIndicator=true
resilience4j.circuitbreaker.instances.inventory.event-consumer-buffer-size=10
resilience4j.circuitbreaker.instances.inventory.slidingWindowType=COUNT_BASED
resilience4j.circuitbreaker.instances.inventory.slidingWindowSize=10
resilience4j.circuitbreaker.instances.inventory.failureRateThreshold=50
resilience4j.circuitbreaker.instances.inventory.waitDurationInOpenState=5s
resilience4j.circuitbreaker.instances.inventory.permittedNumberOfCallsInHalfOpenState=3
resilience4j.circuitbreaker.instances.inventory.automaticTransitionFromOpenToHalfOpenEnabled=true

resilience4j.timelimiter.instances.inventory.timeout-duration=3s
resilience4j.circuitbreaker.instances.inventory.minimum-number-of-calls=5

resilience4j.retry.instances.inventory.max-attempts=3
resilience4j.retry.instances.inventory.wait-duration=2s

# Week 14 - Kafka Producer Properties (Docker)
spring.kafka.bootstrap-servers=broker:29092
spring.kafka.template.default-topic=order-placed
spring.kafka.producer.key-serializer=org.apache.kafka.common.serialization.StringSerializer

# Week 14 - Avro Serializer with Schema Registry (Docker)
spring.kafka.producer.value-serializer=io.confluent.kafka.serializers.KafkaAvroSerializer
spring.kafka.producer.properties.schema.registry.url=http://schema-registry:8087
```

**Note:** In Docker, the Schema Registry URL uses the container name `schema-registry` instead of `localhost` or `127.0.0.1`.

### C.2 Update notification-service/src/main/resources/application-docker.properties

Add/update the Kafka consumer properties to use Avro deserialization:

```properties
spring.application.name=notification-service

# Week 14
server.port=8085

# Week 14 - Kafka Consumer Properties (Docker)
spring.kafka.bootstrap-servers=broker:29092
spring.kafka.consumer.group-id=notificationService
spring.kafka.consumer.key-deserializer=org.apache.kafka.common.serialization.StringDeserializer
spring.kafka.consumer.auto-offset-reset=earliest

# Week 14 - Avro Deserializer with Error Handling (Docker)
spring.kafka.consumer.value-deserializer=org.springframework.kafka.support.serializer.ErrorHandlingDeserializer
spring.kafka.consumer.properties.spring.deserializer.key.delegate.class=org.apache.kafka.common.serialization.StringDeserializer
spring.kafka.consumer.properties.spring.deserializer.value.delegate.class=io.confluent.kafka.serializers.KafkaAvroDeserializer
spring.kafka.consumer.properties.schema.registry.url=http://schema-registry:8087
spring.kafka.consumer.properties.specific.avro.reader=true

# Week 14 - Actuator & Logging
management.endpoints.web.exposure.include=*
management.endpoint.health.show-details=always
logging.level.org.springframework.kafka=DEBUG
logging.level.ca.gbc.comp3095.notificationservice=DEBUG

# Week 14 - MailTrap Configuration
spring.mail.host=sandbox.smtp.mailtrap.io
spring.mail.port=2525
spring.mail.username=YOUR_MAILTRAP_USERNAME
spring.mail.password=YOUR_MAILTRAP_PASSWORD
spring.mail.from=noreply@comp3095.ca
spring.mail.properties.mail.smtp.auth=true
spring.mail.properties.mail.smtp.starttls.enable=true
```

**Important:** Replace `YOUR_MAILTRAP_USERNAME` and `YOUR_MAILTRAP_PASSWORD` with your actual MailTrap credentials.

---

## Step D: Verify shared-schema Module Configuration

### D.1 Verify settings.gradle.kts includes shared-schema

Ensure your `microservices-parent/settings.gradle.kts` includes the shared-schema module:

```kotlin
rootProject.name = "microservices-parent"

include("product-service", "order-service", "inventory-service", "api-gateway", "notification-service")
include("shared-schema")
```

### D.2 Build the shared-schema Module

**CRITICAL:** You must build the shared-schema module to generate the Avro Java classes before the project will compile.

**Using Terminal:**
```bash
cd microservices-parent
./gradlew :shared-schema:build
```

**Using IntelliJ Gradle Panel:**
1. Open the **Gradle** panel (right sidebar, elephant icon)
2. Navigate to: `microservices-parent` → `shared-schema` → `Tasks` → `build` → `build`
3. **Double-click** `build`

After building, verify the generated class exists at:
```
shared-schema/build/generated-main-avro-java/ca/gbc/comp3095/orderservice/event/OrderPlacedEvent.java
```

---

## Summary of Changes Not in Week14.md

| Issue | Location | Fix |
|-------|----------|-----|
| DevTools not removed | order-service/build.gradle.kts | Remove/comment `developmentOnly("spring-boot-devtools")` |
| Invalid Spring Boot version | notification-service/build.gradle.kts | Change 4.0.0 → 3.4.4 |
| Invalid test dependencies | notification-service/build.gradle.kts | Use spring-kafka-test, testcontainers |
| Docker uses JSON not Avro | order-service/application-docker.properties | Use KafkaAvroSerializer + schema.registry.url |
| Docker uses JSON not Avro | notification-service/application-docker.properties | Use KafkaAvroDeserializer + schema.registry.url |

---

## Troubleshooting

### Error: "Cannot resolve symbol 'event'" or "OrderPlacedEvent"
**Solution:** Build the shared-schema module first (Step D.2)

### Error: "No beans of 'JavaMailSender' type found"
**Solution:** This is an IDE warning. Run `./gradlew build` or sync Gradle in IntelliJ.

### Error: "Connection refused" to Schema Registry in Docker
**Solution:** Ensure `application-docker.properties` uses `http://schema-registry:8087` (not localhost)

### Error: Serialization/Deserialization failure in Docker
**Solution:** Ensure both order-service and notification-service docker properties use Avro serializers (Step C)
