# Create DTOs, Services, Repository, and Controller

## Overview

In this section, you will implement the complete layered architecture for the order-service:
1. **DTOs** - Data Transfer Objects for API requests/responses
2. **Repository** - Data access layer
3. **Service** - Business logic layer with transaction management
4. **Controller** - REST API layer

---

## Step 1: Create OrderLineItemDto

### 1.1 Create OrderLineItemDto Class

**Location:** `order-service/src/main/java/ca/gbc/comp3095/orderservice/dto/OrderLineItemDto.java`

**Steps:**
1. Right-click on `dto` package
2. Select **New → Java Class**
3. Name: `OrderLineItemDto`
4. Click **OK**

### 1.2 Implement OrderLineItemDto

**Complete OrderLineItemDto.java:**

```java
package ca.gbc.comp3095.orderservice.dto;

import java.math.BigDecimal;

public record OrderLineItemDto(
    Long id,
    String skuCode,
    BigDecimal price,
    Integer quantity
) {}
```

**Why Java Record?**
- Immutable by default (best practice for DTOs)
- Automatically generates constructor, getters, equals, hashCode, toString
- Concise syntax (no Lombok needed)
- Same pattern as product-service DTOs

**Fields:**
- `id` - Optional, not used in POST requests but available for future use
- `skuCode` - Product identifier (e.g., "sku_12334A")
- `price` - Item price as BigDecimal for precision
- `quantity` - Number of items

---

## Step 2: Create OrderRequest

### 2.1 Create OrderRequest Class

**Location:** `order-service/src/main/java/ca/gbc/comp3095/orderservice/dto/OrderRequest.java`

**Steps:**
1. Right-click on `dto` package
2. Select **New → Java Class**
3. Name: `OrderRequest`
4. Click **OK**

### 2.2 Implement OrderRequest

**Complete OrderRequest.java:**

```java
package ca.gbc.comp3095.orderservice.dto;

import java.util.List;

public record OrderRequest(
    List<OrderLineItemDto> orderLineItemDtoList
) {}
```

**Why Java Record?**
- Consistent with product-service pattern
- Immutable (DTOs should not be modified)
- Clean, concise syntax
- Automatically handles JSON serialization/deserialization

**Purpose:**
- Represents the request body for POST /api/order
- Contains list of order line items
- No order number in request (generated by service)

---

## Step 3: Create OrderRepository

### 3.1 Create OrderRepository Interface

**Location:** `order-service/src/main/java/ca/gbc/comp3095/orderservice/repository/OrderRepository.java`

**Steps:**
1. Right-click on `repository` package
2. Select **New → Java Class**
3. In the dialog, change **Kind** from "Class" to **Interface**
4. Name: `OrderRepository`
5. Click **OK**

### 3.2 Implement OrderRepository

**Complete OrderRepository.java:**

```java
package ca.gbc.comp3095.orderservice.repository;

import ca.gbc.comp3095.orderservice.model.Order;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;

@Repository
public interface OrderRepository extends JpaRepository<Order, Long> {
    // No methods needed - JpaRepository provides all CRUD operations
}
```

**What is JpaRepository?**
- Spring Data JPA interface
- Provides built-in CRUD operations
- No implementation needed (Spring generates it)

**Generic Parameters:**
```java
JpaRepository<Order, Long>
            │     │
            │     └─ Primary key type (Long)
            └─ Entity type (Order)
```

**Built-in Methods (No Code Needed):**
- `save(Order order)` - Save or update order
- `findById(Long id)` - Find order by ID
- `findAll()` - Get all orders
- `deleteById(Long id)` - Delete order by ID
- `count()` - Count total orders
- `existsById(Long id)` - Check if order exists

---

## Step 4: Create OrderService

### 4.1 Create OrderService Class

**Location:** `order-service/src/main/java/ca/gbc/comp3095/orderservice/service/OrderService.java`

**Steps:**
1. Right-click on `service` package
2. Select **New → Java Class**
3. Name: `OrderService`
4. Click **OK**

### 4.2 Implement OrderService

**Complete OrderService.java:**

```java
package ca.gbc.comp3095.orderservice.service;

import ca.gbc.comp3095.orderservice.dto.OrderLineItemDto;
import ca.gbc.comp3095.orderservice.dto.OrderRequest;
import ca.gbc.comp3095.orderservice.model.Order;
import ca.gbc.comp3095.orderservice.model.OrderLineItem;
import ca.gbc.comp3095.orderservice.repository.OrderRepository;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.List;
import java.util.UUID;

@Service
@RequiredArgsConstructor
@Slf4j
@Transactional
public class OrderService {

    private final OrderRepository orderRepository;

    public void placeOrder(OrderRequest orderRequest) {
        // Generate unique order number
        String orderNumber = UUID.randomUUID().toString();

        // Convert DTOs to Entities
        List<OrderLineItem> orderLineItems = orderRequest.getOrderLineItemDtoList()
                .stream()
                .map(this::mapToOrderLineItem)
                .toList();

        // Create Order entity
        Order order = Order.builder()
                .orderNumber(orderNumber)
                .orderLineItems(orderLineItems)
                .build();

        // Save order (cascade will save line items)
        orderRepository.save(order);

        log.info("Order {} placed successfully with {} items",
                orderNumber, orderLineItems.size());
    }

    private OrderLineItem mapToOrderLineItem(OrderLineItemDto dto) {
        return OrderLineItem.builder()
                .skuCode(dto.skuCode())
                .price(dto.price())
                .quantity(dto.quantity())
                .build();
    }
}
```

### 4.3 Understanding the Code

**Class-Level Annotations:**

**@Service:**
- Marks class as service component
- Spring will detect and manage as bean

**@RequiredArgsConstructor (Lombok):**
- Generates constructor for `final` fields
- Enables constructor-based dependency injection

**@Slf4j (Lombok):**
- Generates logger field
- Use with: `log.info()`, `log.error()`, `log.debug()`

**@Transactional:**
- All methods execute in database transaction
- Automatic rollback on exception
- ACID guarantees (Atomicity, Consistency, Isolation, Durability)

**placeOrder() Method:**

**1. Generate Order Number:**
```java
String orderNumber = UUID.randomUUID().toString();
```
- Generates unique identifier: "550e8400-e29b-41d4-a716-446655440000"

**2. Convert DTOs to Entities:**
```java
List<OrderLineItem> orderLineItems = orderRequest.getOrderLineItemDtoList()
        .stream()
        .map(this::mapToOrderLineItem)
        .toList();
```
- Stream over DTO list
- Map each DTO to entity using helper method

**3. Create Order Entity:**
```java
Order order = Order.builder()
        .orderNumber(orderNumber)
        .orderLineItems(orderLineItems)
        .build();
```
- Use Builder pattern
- No need to set ID (auto-generated)

**4. Save Order:**
```java
orderRepository.save(order);
```
- Saves order to database
- **Cascade saves line items** (because of `CascadeType.ALL`)

**mapToOrderLineItem() Helper Method:**
```java
private OrderLineItem mapToOrderLineItem(OrderLineItemDto dto) {
    return OrderLineItem.builder()
            .skuCode(dto.skuCode())
            .price(dto.price())
            .quantity(dto.quantity())
            .build();
}
```
- Converts DTO (record) to Entity
- **Record accessor methods:** Use `dto.skuCode()` not `dto.getSkuCode()`
- No ID set (auto-generated on save)

---

## Step 5: Create OrderController

### 5.1 Create OrderController Class

**Location:** `order-service/src/main/java/ca/gbc/comp3095/orderservice/controller/OrderController.java`

**Steps:**
1. Right-click on `controller` package
2. Select **New → Java Class**
3. Name: `OrderController`
4. Click **OK**

### 5.2 Implement OrderController

**Complete OrderController.java:**

```java
package ca.gbc.comp3095.orderservice.controller;

import ca.gbc.comp3095.orderservice.dto.OrderRequest;
import ca.gbc.comp3095.orderservice.service.OrderService;
import lombok.RequiredArgsConstructor;
import org.springframework.http.HttpStatus;
import org.springframework.web.bind.annotation.*;

@RestController
@RequestMapping("/api/order")
@RequiredArgsConstructor
public class OrderController {

    private final OrderService orderService;

    @PostMapping
    @ResponseStatus(HttpStatus.CREATED)
    public String placeOrder(@RequestBody OrderRequest orderRequest) {
        orderService.placeOrder(orderRequest);
        return "Order Placed Successfully";
    }
}
```

### 5.3 Understanding the Code

**Class-Level Annotations:**

**@RestController:**
- Combines `@Controller` + `@ResponseBody`
- All methods return data (not views)
- Responses automatically serialized to JSON

**@RequestMapping:**
```java
@RequestMapping("/api/order")
```
- Base path for all endpoints in this controller
- All methods will be under `/api/order`

**@RequiredArgsConstructor:**
- Generates constructor for `final` fields
- Injects OrderService dependency

**placeOrder() Method:**

**@PostMapping:**
- Maps HTTP POST requests
- Full path: `POST /api/order`

**@ResponseStatus:**
```java
@ResponseStatus(HttpStatus.CREATED)
```
- Sets HTTP status code to 201 Created
- Standard for POST endpoints that create resources

**@RequestBody:**
```java
public String placeOrder(@RequestBody OrderRequest orderRequest)
```
- Deserializes JSON request body to OrderRequest object
- Spring automatically converts JSON to Java object

---

## Summary

### What You Created:

**DTOs (Java Records):**
- ✅ `OrderLineItemDto` - Immutable record for line items
- ✅ `OrderRequest` - Immutable record for order requests

**Repository:**
- ✅ `OrderRepository` - Data access layer, extends JpaRepository

**Service:**
- ✅ `OrderService` - Business logic layer
  - Generates order numbers
  - Converts DTOs to entities
  - Saves orders with transaction management

**Controller:**
- ✅ `OrderController` - REST API layer
  - POST /api/order endpoint
  - Returns 201 Created status

---

## Next Steps

Continue to [05-database-configuration.md](05-database-configuration.md)

---

**Files Created in This Section:**
- ✅ `OrderLineItemDto.java` - Java record for line items
- ✅ `OrderRequest.java` - Java record for order requests
- ✅ `OrderRepository.java` - Repository interface
- ✅ `OrderService.java` - Service with business logic
- ✅ `OrderController.java` - REST controller
